---
title: "Full Report"
author: "Nick Birk"
date: "11/29/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

We will investigate annual fruit and vegetable availability in America.

# Data Assembly

We will begin by reading in the annual availability data, courtesty of the US Department of Agriculture. These data are given in the form of annual availabile pounds per capita for specific fruits and vegetables (10 of each are included here), and overall annual availability of fruits and vegetables per capita from 1970 to 2016.

```{r}
if(!require(tidyverse)) install.packages('tidyverse')
library(tidyverse)

#Total fruit and vegetable data
fruitveg <- read.csv('fruitveg.csv')

#Specific fruits and vegetables
apples <- read.csv('apples.csv')
avocados <- read.csv('avocados.csv')
bananas <- read.csv('bananas.csv')
bellpeppers <- read.csv('bellpeppers.csv')
broccoli <- read.csv('broccoli.csv')
cabbage <- read.csv('cabbage.csv')
carrots <- read.csv('carrots.csv')
eggplant <- read.csv('eggplant.csv')
grapes <- read.csv('grapes.csv')
lemons <- read.csv('lemons.csv')
mushrooms <- read.csv('mushrooms.csv')
onions <- read.csv('onions.csv')
oranges <- read.csv('oranges.csv')
peaches <- read.csv('peaches.csv')
pears <- read.csv('pears.csv')
pineapples <- read.csv('pineapples.csv')
potatoes <- read.csv('potatoes.csv')
spinach <- read.csv('spinach.csv')
tomatoes <- read.csv('tomatoes.csv')
watermelon <- read.csv('watermelon.csv')
```

Now, we can read in the data for potential covariates. Sources include the gapminder dataset, 

```{r}
if(!require(dslabs)) install.packages('dslabs')
library(dslabs)

usgapminder <- gapminder %>% 
  filter(year %in% c(1970:2017) & country == 'United States') %>% 
  dplyr::select('year', 'life_expectancy', 'population', 'gdp')


```


Now, we may combine the separate datasets. 



We will build a shiny app to allow customized visualizations as follows:

```{r}
if(!require(shiny)) install.packages('shiny')
library(shiny)
if(!require(shinythemes)) install.packages('shinythemes')
library(shinythemes)



```


Here is a sample app:
```{r}
# Define UI
ui <- fluidPage( 
  theme = shinythemes::shinytheme("darkly"),
  titlePanel("US Per Capita Produce Availability"),
  tabsetPanel(
    tabPanel('Specific Products Time Series',
      selectInput("country", label = "Select a comparison country",
                             choices = as.list(levels(gapminder$country))),
      mainPanel(plotOutput('linePlot'))
               ),
    tabPanel('Covariate Associations',
             sliderInput('year', label = 'Select a year',
                         min = 1960, max = 2016, value = 1960,
                         step = 1, sep = '', ticks = FALSE),
             
             checkboxGroupInput('continents', label = "Select continents to plot", choices = unique(gapminder$continent), selected = unique(gapminder$continent)
                           ),
             
      plotOutput("scatterPlot",
        click = "scatterPlot_click"),
      dataTableOutput("click_info")
    )
  )
  )



# Define server
server <- function(input, output) {
  
    gap_year <- reactive(gapminder %>% filter(year == input$year))
    
  output$linePlot = renderPlot({
    gapminder %>% filter(country == 'United States' | country == input$country) %>% 
      ggplot(aes(x = year, y = life_expectancy, color = country)) + 
      geom_line() + ggtitle('Life Expectancy over Time') + xlab('Year') +
      ylab('Average life expectancy (in years)') + 
	    scale_y_continuous(breaks = seq(10, 85, 5), limits = c(10, 85))
  })
  output$scatterPlot = renderPlot({
    gap_year() %>% filter(continent %in% input$continents) %>% ggplot(aes(x = fertility, y = life_expectancy, color = continent)) + geom_point() + ggtitle(paste0('Life Expectancy by Fertility Rate in ', input$year)) + xlab('Fertility Rate') + ylab("Life Expectancy") +
      scale_y_continuous(breaks = seq(10, 85, 5), limits = c(10, 85)) +
      scale_x_continuous(breaks = seq(0, 10), limits = c(0, 10))
  })
  
  output$click_info <- renderDataTable({
    # Because it's a ggplot2, we don't need to supply xvar or yvar; if this
    # were a base graphics plot, we'd need those.
    #Nothing seems to show up without the Cairo package 
    nearPoints(df = gap_year(), coordinfo = input$scatterPlot_click, xvar = 'fertility', yvar = 'life_expectancy',  addDist = TRUE, maxpoints = 5)
    
    #So the below works
    #gap_year()$fertility[0:5]
    
    #What's not clicking
    #input$scatterPlot_click
  })

}

shinyApp(ui = ui, server = server)
```


